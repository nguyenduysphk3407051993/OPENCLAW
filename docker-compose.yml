services:
  openclaw-gateway:
    #build:
    #  context: .
    #  dockerfile: docker/Dockerfile
    #image: openclaw:local
    image: openclaw-texlive
    container_name: openclaw-gateway
    restart: unless-stopped
    expose:
      - "18789"
    ports:
      - "18789:18789"
    volumes:
      # Duy lưu ý: Đảm bảo thư mục ./config trên VPS có quyền chmod 700
      - ./config:/home/openclaw/.openclaw
      - ./data/workspace:/home/openclaw/.openclaw/workspace
      - ./skills:/app/skills-user:rw
    env_file: .env
    environment:
      - NODE_ENV=production
      - GATEWAY_MODE=remote
      - GATEWAY_BIND=0.0.0.0
      - GATEWAY_TRUSTED_PROXIES=172.18.0.0/16,127.0.0.1
      # Thêm biến này để OpenClaw biết thư mục nhà chính xác
      - OPENCLAW_STATE_DIR=/home/openclaw/.openclaw
    command:
      - /bin/sh
      - -lc
      - |
        echo "=== Preparing directories ===";
        mkdir -p /home/openclaw/.openclaw/agents/main/sessions;
        mkdir -p /home/openclaw/.openclaw/credentials;
        echo "=== Linking user skills ===";
        for d in /app/skills-user/*/; do
          skill_name=$$(basename "$$d");
          target="/app/skills/$$skill_name";
          if [ ! -e "$$target" ]; then
            ln -sfn "$$d" "$$target";
            echo "  Linked: $$skill_name";
          fi;
        done;
        # Chạy doctor để tự sửa lỗi cấu hình trước khi start
        node /app/dist/index.js doctor --fix;
        # Khởi chạy gateway chính thức
        exec node /app/dist/index.js gateway
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openclaw.rule=Host(`openclaw.${DOMAIN_NAME}`)"
      - "traefik.http.routers.openclaw.entrypoints=websecure"
      - "traefik.http.routers.openclaw.tls.certresolver=letsencrypt"
      - "traefik.http.services.openclaw.loadbalancer.server.port=18789"
      # ĐÃ XÓA middleware làm trống X-Forwarded-For để Gateway nhận diện được IP

  openclaw-cli:
    #image: openclaw:local
    image: openclaw-texlive
    container_name: openclaw-cli
    volumes:
      - ./config:/home/openclaw/.openclaw
      - ./data/workspace:/home/openclaw/.openclaw/workspace
      - ./skills:/app/skills-user:rw
    env_file: .env
    environment:
      - NODE_ENV=production
      - OPENCLAW_STATE_DIR=/home/openclaw/.openclaw

    entrypoint: [ "node", "/app/dist/index.js" ]
    networks:
      - traefik-network
    profiles:
      - cli
    stdin_open: true
    tty: true

networks:
  traefik-network:
    external: true
    
##FIX Permission denied
#mkdir -p config/agents/main/sessions config/credentials
#chmod -R 700 config